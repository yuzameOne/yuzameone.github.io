<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Платежный календарь</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-color: #3B82F6;
      --secondary-color: #1E40AF;
      --danger-color: #EF4444;
      --success-color: #10B981;
      --text-color: #1F2937;
      --bg-color: #FFFFFF;
      --border-color: #E5E7EB;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
    }

    .day-cell {
      transition: all 0.2s ease;
      min-height: 60px;
      display: flex;
      flex-direction: column;
      background-color: var(--bg-color);
      border: 1px solid var(--border-color);
    }

    .day-content {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .payment-amount {
      margin-top: auto;
      font-size: 0.75rem;
    }

    .day-cell:hover {
      transform: scale(1.05);
      box-shadow: 0 0 0 2px var(--primary-color);
      z-index: 10;
    }

    .payment-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      border-bottom: 1px solid var(--border-color);
    }

    .delete-btn {
      color: var(--danger-color);
      cursor: pointer;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .dialog {
      background-color: var(--bg-color);
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .toggle-option {
      transition: all 0.3s ease;
      cursor: pointer;
      text-align: center;
      padding: 8px;
    }

    .toggle-option.active {
      background-color: var(--primary-color);
      color: white;
    }

    .selected-date {
      text-align: center;
      margin-bottom: 1rem;
    }

    .month-total {
      text-align: center;
      font-weight: bold;
      padding: 1rem;
      border-top: 1px solid var(--border-color);
      background-color: var(--bg-color);
    }

    .auth-error {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      text-align: center;
      padding: 20px;
    }

    .chart-container {
      margin-top: 1rem;
      height: 200px;
    }

    .category-badge {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.75rem;
      margin-left: 4px;
    }

    .theme-toggle {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 100;
    }
  </style>
</head>
<body>
  <div id="authErrorContainer" class="auth-error hidden">
    <div class="max-w-md p-6 bg-white rounded-lg shadow-md">
      <h2 class="text-2xl font-bold text-red-600 mb-4">Ошибка доступа</h2>
      <p id="authErrorMessage" class="mb-4"></p>
      <p class="text-sm text-gray-500">Обратитесь к администратору</p>
    </div>
  </div>

  <div id="appContainer" class="hidden">
    <div class="max-w-md mx-auto bg-white rounded-lg shadow-md overflow-hidden">
      <div class="bg-blue-500 text-white py-3 px-4 flex justify-between items-center">
        <button id="prevMonth" class="text-white hover:text-blue-200 focus:outline-none">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
          </svg>
        </button>
        <h2 id="currentMonth" class="text-center font-semibold text-lg"></h2>
        <button id="nextMonth" class="text-white hover:text-blue-200 focus:outline-none">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
          </svg>
        </button>
      </div>
      
      <div class="grid grid-cols-7 gap-1 p-2 bg-gray-100">
        <div class="text-center text-gray-600 font-medium text-sm py-1">Пн</div>
        <div class="text-center text-gray-600 font-medium text-sm py-1">Вт</div>
        <div class="text-center text-gray-600 font-medium text-sm py-1">Ср</div>
        <div class="text-center text-gray-600 font-medium text-sm py-1">Чт</div>
        <div class="text-center text-gray-600 font-medium text-sm py-1">Пт</div>
        <div class="text-center text-gray-600 font-medium text-sm py-1">Сб</div>
        <div class="text-center text-gray-600 font-medium text-sm py-1">Вс</div>
      </div>
      
      <div id="calendarDays" class="grid grid-cols-7 gap-1 p-2"></div>

      <div class="month-total">
        Итого за месяц: <span id="monthTotal">0</span> ₽
      </div>
    </div>

    <div id="overlay" class="overlay hidden">
      <div class="dialog">
        <div id="actionsMenu" class="p-4">
          <div class="selected-date">
            <h3 class="text-lg font-semibold" id="selectedDateTitle"></h3>
          </div>
          <div class="grid grid-cols-1 gap-2">
            <button id="addPaymentBtn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">
              Добавить платеж
            </button>
            <button id="deletePaymentsBtn" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition">
              Удалить платежи
            </button>
            <button id="showDescriptionsBtn" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition">
              Просмотреть платежи
            </button>
          </div>
          <div class="flex justify-end mt-4">
            <button id="cancelActions" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 transition">
              Закрыть
            </button>
          </div>
        </div>

        <div id="addPaymentForm" class="p-4 hidden">
          <div class="selected-date">
            <h3 class="text-lg font-semibold" id="formTitle"></h3>
          </div>
          <form id="paymentForm">
            <div class="mb-4">
              <label class="block text-gray-700 mb-2" for="amount">Сумма (₽)</label>
              <input type="number" id="amount" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div class="mb-4">
              <label class="block text-gray-700 mb-2" for="description">Описание</label>
              <input type="text" id="description" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="mb-4">
              <label class="block text-gray-700 mb-2">Тип платежа</label>
              <div class="flex border rounded overflow-hidden">
                <div id="oneTimeOption" class="toggle-option flex-1 active" data-value="one-time">
                  Разовый
                </div>
                <div id="recurringOption" class="toggle-option flex-1" data-value="recurring">
                  Постоянный
                </div>
              </div>
              <input type="hidden" id="paymentType" name="paymentType" value="one-time">
            </div>
            <div class="flex space-x-2">
              <button type="submit" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">
                Добавить
              </button>
              <button type="button" id="cancelAdd" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 transition">
                Отмена
              </button>
            </div>
          </form>
        </div>

        <div id="deletePaymentsList" class="p-4 hidden">
          <div class="selected-date">
            <h3 class="text-lg font-semibold">Выберите платежи для удаления</h3>
          </div>
          <div id="paymentsToDelete" class="mb-4"></div>
          <div class="flex justify-end">
            <button id="cancelDelete" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 transition">
              Назад
            </button>
          </div>
        </div>

        <div id="paymentsDescriptionList" class="p-4 hidden">
          <div class="selected-date">
            <h3 class="text-lg font-semibold">Платежи</h3>
          </div>
          <div id="paymentsDescriptions" class="mb-4"></div>
          <div class="flex justify-end">
            <button id="cancelDescription" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 transition">
              Назад
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
    import { 
      getFirestore, 
      collection, 
      addDoc, 
      getDocs, 
      deleteDoc, 
      doc, 
      query, 
      where, 
      onSnapshot,
      Timestamp,
      setDoc
    } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore.js";

    // Конфигурация Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAPX_GlZVyQN7KwFY-MdtJBE_VyJGsfGPc",
      authDomain: "payment-calendar-5e433.firebaseapp.com",
      projectId: "payment-calendar-5e433",
      storageBucket: "payment-calendar-5e433.appspot.com",
      messagingSenderId: "878161899746",
      appId: "1:878161899746:web:d986d3296683d08c80eebb",
      measurementId: "G-6B7DT74CWE"
    };

    // Инициализация Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Создание структуры базы данных
    async function createDatabaseStructure() {
      try {
        // Создаем корневые документы для структуры, если их нет
        const paymentsRef = collection(db, "payments");
        const oneTimeRef = doc(paymentsRef, "one_time");
        const recurringRef = doc(paymentsRef, "recurring");

        // Проверяем существование документов
        const oneTimeDoc = await getDocs(oneTimeRef);
        const recurringDoc = await getDocs(recurringRef);

        if (!oneTimeDoc.exists()) {
          await setDoc(oneTimeRef, { type: "one_time_payments" });
        }
        if (!recurringDoc.exists()) {
          await setDoc(recurringRef, { type: "recurring_payments" });
        }

        console.log("Database structure verified/created");
      } catch (error) {
        console.error("Error in createDatabaseStructure:", error);
      }
    }

    // Список разрешенных User ID
    const ALLOWED_USER_IDS = [
      "564940168",
      "579486395"
    ];

    // Глобальные переменные
    let currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    let selectedDate = null;
    let paymentsData = {};
    let currentUserId = null;
    let unsubscribePayments = null;

    const months = [
      'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
      'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
    ];

    // Функции аутентификации
    function checkAuth() {
      try {
        const tg = window.Telegram.WebApp;
        
        if (!tg.initDataUnsafe?.user?.id) {
          showAuthError("Не удалось получить данные пользователя");
          return false;
        }

        const userId = tg.initDataUnsafe.user.id.toString();
        
        if (!ALLOWED_USER_IDS.includes(userId)) {
          showAuthError("Доступ запрещен");
          return false;
        }

        currentUserId = userId;
        return true;
      } catch (error) {
        showAuthError("Ошибка авторизации");
        return false;
      }
    }

    function showAuthError(message) {
      document.getElementById('authErrorMessage').textContent = message;
      document.getElementById('authErrorContainer').classList.remove('hidden');
      document.getElementById('appContainer').classList.add('hidden');
    }

    // Функции календаря
    function formatDate(date) {
      if (!(date instanceof Date)) {
        date = new Date(date);
      }
      let month = '' + (date.getMonth() + 1);
      let day = '' + date.getDate();
      const year = date.getFullYear();
      
      if (month.length < 2) month = '0' + month;
      if (day.length < 2) day = '0' + day;
      
      return [year, month, day].join('-');
    }

    function formatDisplayDate(date) {
      return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
    }

    function calculateMonthTotal() {
      let total = 0;
      
      Object.entries(paymentsData).forEach(([dateString, payments]) => {
        const date = new Date(dateString);
        if (date.getMonth() === currentMonth && date.getFullYear() === currentYear) {
          payments.forEach(payment => {
            total += payment.amount;
          });
        }
      });
      
      document.getElementById('monthTotal').textContent = total.toLocaleString();
    }

    async function initCalendar() {
      console.log('Initializing calendar...');
      
      try {
        // Слушатель для разовых платежей
        const oneTimeQuery = query(
          collection(db, "payments/one_time/items"),
          where("userId", "==", currentUserId)
        );
        
        // Слушатель для повторяющихся платежей
        const recurringQuery = query(
          collection(db, "payments/recurring/items"),
          where("userId", "==", currentUserId)
        );

        // Отписываемся от предыдущих подписок
        if (unsubscribePayments) {
          unsubscribePayments();
        }

        // Обработчик разовых платежей
        const unsubscribeOneTime = onSnapshot(oneTimeQuery, (snapshot) => {
          console.log('Received one-time payments:', snapshot.size);
          const oneTimePayments = {};
          
          snapshot.forEach((doc) => {
            const payment = doc.data();
            if (!payment.date) {
              console.warn('Payment without date:', doc.id);
              return;
            }
            
            const date = payment.date.toDate();
            const dateStr = formatDate(date);
            
            if (!oneTimePayments[dateStr]) {
              oneTimePayments[dateStr] = [];
            }
            
            oneTimePayments[dateStr].push({
              id: doc.id,
              ...payment,
              date: date
            });
          });
          
          console.log('Processed one-time payments:', oneTimePayments);
          paymentsData = { ...paymentsData, ...oneTimePayments };
          generateCalendar(currentMonth, currentYear);
        }, (error) => {
          console.error('Error in one-time payments listener:', error);
        });

        // Обработчик повторяющихся платежей
        const unsubscribeRecurring = onSnapshot(recurringQuery, async (snapshot) => {
          console.log('Received recurring payments:', snapshot.size);
          const recurringPayments = {};
          
          for (const doc of snapshot.docs) {
            const template = doc.data();
            console.log('Processing recurring template:', template);
            
            if (!template.startDate) {
              console.warn('Template without start date:', doc.id);
              continue;
            }

            try {
              const instancesRef = collection(doc.ref, "instances");
              const instancesSnapshot = await getDocs(instancesRef);
              console.log('Found instances:', instancesSnapshot.size);
              
              instancesSnapshot.forEach((instanceDoc) => {
                const instance = instanceDoc.data();
                const dateStr = instance.date;
                
                if (!recurringPayments[dateStr]) {
                  recurringPayments[dateStr] = [];
                }
                
                recurringPayments[dateStr].push({
                  id: instanceDoc.id,
                  templateId: doc.id,
                  ...template,
                  date: new Date(dateStr)
                });
              });
            } catch (error) {
              console.error('Error processing recurring payment:', doc.id, error);
            }
          }
          
          console.log('Processed recurring payments:', recurringPayments);
          paymentsData = { ...paymentsData, ...recurringPayments };
          generateCalendar(currentMonth, currentYear);
        }, (error) => {
          console.error('Error in recurring payments listener:', error);
        });

        // Сохраняем функции отписки
        unsubscribePayments = () => {
          unsubscribeOneTime();
          unsubscribeRecurring();
        };

      } catch (error) {
        console.error('Error in initCalendar:', error);
        showError('Ошибка при инициализации календаря');
      }
    }

    function generateCalendar(month, year) {
      console.log('Generating calendar for:', month, year);
      const calendarDays = document.getElementById('calendarDays');
      const currentMonthElement = document.getElementById('currentMonth');
      
      currentMonthElement.textContent = `${months[month]} ${year}`;
      calendarDays.innerHTML = '';
      
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const firstDayOfWeek = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
      const prevLastDay = new Date(year, month, 0).getDate();
      
      console.log('Calendar parameters:', {
        firstDay,
        lastDay,
        firstDayOfWeek,
        prevLastDay
      });
      
      // Add empty cells for days before the first day of the month
      for (let i = firstDayOfWeek; i > 0; i--) {
        const day = prevLastDay - i + 1;
        const dayElement = document.createElement('div');
        dayElement.className = 'text-center py-1 text-gray-400 day-cell';
        dayElement.innerHTML = `
          <div class="day-content">${day}</div>
          <div class="payment-amount text-xs h-4"></div>
        `;
        calendarDays.appendChild(dayElement);
      }
      
      // Add days of the current month
      for (let i = 1; i <= lastDay.getDate(); i++) {
        const dayElement = document.createElement('div');
        const date = new Date(year, month, i);
        const dateString = formatDate(date);
        const payments = paymentsData[dateString] || [];
        
        console.log(`Day ${i}:`, {
          dateString,
          payments: payments.length
        });
        
        const isToday = i === currentDate.getDate() && 
                        month === currentDate.getMonth() && 
                        year === currentDate.getFullYear();
        
        let paymentDisplay = '';
        let dayClasses = 'text-center py-1 day-cell rounded';
        
        if (payments.length > 0) {
          const totalAmount = payments.reduce((sum, payment) => sum + payment.amount, 0);
          const hasRecurring = payments.some(p => p.paymentType === 'recurring');
          const hasOneTime = payments.some(p => p.paymentType === 'one-time');
          
          let paymentClasses = 'text-xs font-medium';
          if (hasRecurring && hasOneTime) {
            paymentClasses += ' text-purple-600';
          } else if (hasRecurring) {
            paymentClasses += ' text-green-600';
          } else {
            paymentClasses += ' text-red-600';
          }
          
          paymentDisplay = `
            <div class="payment-amount ${paymentClasses}">
              ${totalAmount.toLocaleString()} ₽
            </div>
          `;
        } else {
          paymentDisplay = '<div class="payment-amount text-xs h-4"></div>';
        }
        
        if (isToday) {
          dayClasses += ' bg-blue-100 font-bold';
        }
        
        dayElement.className = dayClasses;
        dayElement.innerHTML = `
          <div class="day-content">${i}</div>
          ${paymentDisplay}
        `;
        
        dayElement.addEventListener('click', () => {
          selectedDate = date;
          document.getElementById('selectedDateTitle').textContent = 
            `Платежи на ${formatDisplayDate(date)}`;
          showActionsMenu();
        });
        
        calendarDays.appendChild(dayElement);
      }
      
      // Add empty cells for days after the last day of the month
      const totalDays = firstDayOfWeek + lastDay.getDate();
      const remainingDays = 7 - (totalDays % 7);
      
      if (remainingDays < 7) {
        for (let i = 1; i <= remainingDays; i++) {
          const dayElement = document.createElement('div');
          dayElement.className = 'text-center py-1 text-gray-400 day-cell';
          dayElement.innerHTML = `
            <div class="day-content">${i}</div>
            <div class="payment-amount text-xs h-4"></div>
          `;
          calendarDays.appendChild(dayElement);
        }
      }
      
      calculateMonthTotal();
    }

    function showOverlay() {
      document.getElementById('overlay').classList.remove('hidden');
    }

    function hideOverlay() {
      document.getElementById('overlay').classList.add('hidden');
    }

    function showActionsMenu() {
      hideAllForms();
      showOverlay();
      document.getElementById('actionsMenu').classList.remove('hidden');
    }

    function showAddForm() {
      hideAllForms();
      document.getElementById('addPaymentForm').classList.remove('hidden');
      document.getElementById('formTitle').textContent = 
        `Добавить платеж на ${formatDisplayDate(selectedDate)}`;
    }

    function showDeleteList() {
      hideAllForms();
      const container = document.getElementById('paymentsToDelete');
      container.innerHTML = '';
      
      const dateString = formatDate(selectedDate);
      const payments = paymentsData[dateString] || [];
      
      if (payments.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">Нет платежей для удаления</p>';
      } else {
        payments.forEach(payment => {
          const paymentEl = document.createElement('div');
          paymentEl.className = 'payment-item';
          const isRecurring = payment.paymentType === 'recurring';
          paymentEl.innerHTML = `
            <div class="flex justify-between items-center w-full">
              <div>
                <div class="font-medium">${payment.amount.toLocaleString()} ₽</div>
                ${payment.description ? `<div class="text-sm text-gray-600">${payment.description}</div>` : ''}
              </div>
              <button class="delete-btn px-3 py-1 rounded hover:bg-red-100" 
                      onclick="deletePayment('${payment.id}', ${isRecurring})">
                Удалить
              </button>
            </div>
          `;
          container.appendChild(paymentEl);
        });
      }
      
      document.getElementById('deletePaymentsList').classList.remove('hidden');
    }

    function hideAllForms() {
      document.getElementById('actionsMenu').classList.add('hidden');
      document.getElementById('addPaymentForm').classList.add('hidden');
      document.getElementById('deletePaymentsList').classList.add('hidden');
      document.getElementById('paymentsDescriptionList').classList.add('hidden');
    }

    async function initApp() {
      try {
        if (!checkAuth()) return;
        
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        document.getElementById('authErrorContainer').classList.add('hidden');
        document.getElementById('appContainer').classList.remove('hidden');
        
        // Создаем структуру базы данных
        await createDatabaseStructure();
        
        // Инициализируем календарь
        await initCalendar();
        
        // Первичная генерация календаря
        generateCalendar(currentMonth, currentYear);
        
        console.log('App initialized successfully');
      } catch (error) {
        console.error('Error initializing app:', error);
        showError('Ошибка инициализации приложения');
      }
    }

    // Обработчики событий
    document.addEventListener('DOMContentLoaded', initApp);

    document.getElementById('prevMonth').addEventListener('click', () => {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      generateCalendar(currentMonth, currentYear);
    });
    
    document.getElementById('nextMonth').addEventListener('click', () => {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      generateCalendar(currentMonth, currentYear);
    });

    document.getElementById('addPaymentBtn').addEventListener('click', showAddForm);
    document.getElementById('deletePaymentsBtn').addEventListener('click', showDeleteList);
    document.getElementById('showDescriptionsBtn').addEventListener('click', showDescriptions);
    
    document.getElementById('cancelActions').addEventListener('click', hideOverlay);
    document.getElementById('cancelAdd').addEventListener('click', showActionsMenu);
    document.getElementById('cancelDelete').addEventListener('click', showActionsMenu);
    document.getElementById('cancelDescription').addEventListener('click', showActionsMenu);

    document.getElementById('oneTimeOption').addEventListener('click', function() {
      this.classList.add('active', 'bg-blue-500', 'text-white');
      document.getElementById('recurringOption').classList.remove('active', 'bg-blue-500', 'text-white');
      document.getElementById('paymentType').value = 'one-time';
    });

    document.getElementById('recurringOption').addEventListener('click', function() {
      this.classList.add('active', 'bg-blue-500', 'text-white');
      document.getElementById('oneTimeOption').classList.remove('active', 'bg-blue-500', 'text-white');
      document.getElementById('paymentType').value = 'recurring';
    });

    document.getElementById('paymentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const amount = parseFloat(document.getElementById('amount').value);
      const description = document.getElementById('description').value;
      const paymentType = document.getElementById('paymentType').value;
      
      if (!amount || amount <= 0) {
        showError('Введите корректную сумму');
        return;
      }

      if (!selectedDate) {
        showError('Выберите дату');
        return;
      }
      
      try {
        console.log('Adding payment:', {
          amount,
          description,
          paymentType,
          selectedDate,
          userId: currentUserId
        });

        if (paymentType === 'one-time') {
          const docRef = await addDoc(collection(db, "payments/one_time/items"), {
            amount: amount,
            description: description,
            date: Timestamp.fromDate(new Date(selectedDate)),
            userId: currentUserId,
            createdAt: Timestamp.now(),
            paymentType: 'one-time'
          });
          console.log('Added one-time payment:', docRef.id);
        } else {
          const templateRef = await addDoc(collection(db, "payments/recurring/items"), {
            amount: amount,
            description: description,
            startDate: Timestamp.fromDate(new Date(selectedDate)),
            userId: currentUserId,
            createdAt: Timestamp.now(),
            paymentType: 'recurring'
          });
          console.log('Added recurring payment template:', templateRef.id);

          // Создаем экземпляры на 12 месяцев
          const startDate = new Date(selectedDate);
          const endDate = new Date(startDate);
          endDate.setMonth(endDate.getMonth() + 12);
          
          let currentDate = new Date(startDate);
          while (currentDate <= endDate) {
            const instanceRef = await addDoc(collection(templateRef, "instances"), {
              date: formatDate(currentDate),
              userId: currentUserId
            });
            console.log('Added instance:', instanceRef.id, 'for date:', formatDate(currentDate));
            currentDate.setMonth(currentDate.getMonth() + 1);
          }
        }
        
        document.getElementById('paymentForm').reset();
        hideOverlay();
        showSuccess('Платеж успешно добавлен');
      } catch (error) {
        console.error("Error adding payment: ", error);
        showError("Ошибка при добавлении платежа: " + error.message);
      }
    });

    document.getElementById('overlay').addEventListener('click', (e) => {
      if (e.target === document.getElementById('overlay')) {
        hideOverlay();
      }
    });

    // Добавляем вспомогательные функции
    function formatCurrency(amount) {
      return amount.toLocaleString() + ' ₽';
    }

    function showSuccess(message) {
      alert(message);
    }

    function showError(message) {
      alert('Ошибка: ' + message);
    }

    function openModal(modalId) {
      document.getElementById(modalId).classList.remove('hidden');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.add('hidden');
    }

    // Добавляем глобальную функцию deletePayment
    window.deletePayment = async function(paymentId, isRecurring) {
      try {
        if (isRecurring) {
          const templateRef = doc(db, "payments/recurring/items", paymentId);
          const instancesSnapshot = await getDocs(collection(templateRef, "instances"));
          
          // Удаляем все экземпляры
          for (const instance of instancesSnapshot.docs) {
            await deleteDoc(instance.ref);
          }
          
          // Удаляем шаблон
          await deleteDoc(templateRef);
        } else {
          await deleteDoc(doc(db, "payments/one_time/items", paymentId));
        }
        
        showSuccess('Платеж успешно удален');
        showActionsMenu(); // Возвращаемся к меню действий
      } catch (error) {
        console.error('Error deleting payment:', error);
        showError('Ошибка при удалении платежа');
      }
    };

    function showDescriptions() {
      hideAllForms();
      const container = document.getElementById('paymentsDescriptions');
      container.innerHTML = '';
      
      const dateString = formatDate(selectedDate);
      const payments = paymentsData[dateString] || [];
      
      if (payments.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">Нет платежей для отображения</p>';
      } else {
        payments.forEach(payment => {
          const paymentEl = document.createElement('div');
          paymentEl.className = 'payment-item';
          const isRecurring = payment.paymentType === 'recurring';
          paymentEl.innerHTML = `
            <div class="w-full">
              <div class="font-medium">
                ${payment.amount.toLocaleString()} ₽ 
                <span class="text-xs ${isRecurring ? 'text-green-600' : 'text-red-600'}">
                  (${isRecurring ? 'постоянный' : 'разовый'})
                </span>
              </div>
              ${payment.description ? `<div class="text-sm text-gray-600 mt-1">${payment.description}</div>` : ''}
              <div class="text-xs text-gray-500">Создан: ${formatDisplayDate(payment.createdAt.toDate())}</div>
            </div>
          `;
          container.appendChild(paymentEl);
        });
      }
      
      document.getElementById('paymentsDescriptionList').classList.remove('hidden');
    }
  </script>
</body>
</html>
