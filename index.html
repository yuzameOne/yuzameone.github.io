<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Платежный календарь</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        .day-cell {
            transition: all 0.2s ease;
            min-height: 60px;
            display: flex;
            flex-direction: column;
        }
        .day-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .payment-amount {
            margin-top: auto;
        }
        .day-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
            z-index: 10;
        }
        .payment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .delete-btn {
            color: red;
            cursor: pointer;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .dialog {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .toggle-option {
            transition: all 0.3s ease;
            cursor: pointer;
            text-align: center;
            padding: 8px;
        }
        .toggle-option.active {
            background-color: #3B82F6;
            color: white;
        }
        .selected-date {
            text-align: center;
            margin-bottom: 1rem;
        }
        .month-total {
            text-align: center;
            font-weight: bold;
            padding: 1rem;
            border-top: 1px solid #eee;
            background-color: #f8fafc;
        }
        .auth-error {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            padding: 20px;
        }
        
        #appContainer {
            min-height: 100vh;
            padding: 20px;
            background-color: #f3f4f6;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Добавляем отступы и улучшаем видимость календаря */
        .max-w-md {
            margin: 0 auto;
            width: 100%;
            max-width: 28rem;
        }
        
        #calendarDays {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* Стили для деталей платежей */
        .payment-details {
            background-color: #f8fafc;
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
        }
        
        #showPaymentDetailsBtn {
            position: relative;
            width: 100%;
            text-align: center;
            padding-bottom: 0.75rem;
        }
        
        #showPaymentDetailsBtn:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 25%;
            width: 50%;
            height: 2px;
            background-color: #E53E3E;  /* Красное подчеркивание */
            transition: all 0.3s ease;
        }
        
        #showPaymentDetailsBtn:hover:after {
            width: 70%;
            background-color: #C53030;
        }
        
        #paymentDetailsList {
            border-top: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .payment-details-item {
            padding: 6px 0;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px dashed rgba(0, 0, 0, 0.1);
            font-size: 0.875rem;
            min-height: 30px;
            align-items: center;
        }
        
        .payment-details-item span:first-child {
            flex: 1;
            margin-right: 10px;
            word-break: break-word;
            line-height: 1.3;
        }
        
        .payment-details-item span:last-child {
            flex: 0 0 auto;
            white-space: nowrap;
            font-weight: 500;
        }
        
        .payment-details-total {
            margin-top: 10px;
            padding-top: 10px;
            font-weight: bold;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            text-align: right;
        }
    </style>
</head>
<body>
    <div id="authErrorContainer" class="auth-error hidden">
        <div class="max-w-md p-6 bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-bold text-red-600 mb-4">Ошибка доступа</h2>
            <p id="authErrorMessage" class="mb-4"></p>
            <p class="text-sm text-gray-500">Обратитесь к администратору</p>
        </div>
    </div>

    <div id="appContainer" class="hidden">
        <div class="max-w-md mx-auto bg-white rounded-lg shadow-md overflow-hidden">
            <div class="bg-blue-500 text-white py-3 px-4 flex justify-between items-center">
                <button id="prevMonth" class="text-white hover:text-blue-200 focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                </button>
                <h2 id="currentMonth" class="text-center font-semibold text-lg"></h2>
                <button id="nextMonth" class="text-white hover:text-blue-200 focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            
            <div class="grid grid-cols-7 gap-1 p-2 bg-gray-100">
                <div class="text-center text-gray-600 font-medium text-sm py-1">Пн</div>
                <div class="text-center text-gray-600 font-medium text-sm py-1">Вт</div>
                <div class="text-center text-gray-600 font-medium text-sm py-1">Ср</div>
                <div class="text-center text-gray-600 font-medium text-sm py-1">Чт</div>
                <div class="text-center text-gray-600 font-medium text-sm py-1">Пт</div>
                <div class="text-center text-gray-600 font-medium text-sm py-1">Сб</div>
                <div class="text-center text-gray-600 font-medium text-sm py-1">Вс</div>
            </div>
            
            <div id="calendarDays" class="grid grid-cols-7 gap-1 p-2"></div>

            <div class="month-total">
                Итого за месяц: <span id="monthTotal">0</span>
            </div>

            <!-- Кнопка и блок для детализации платежей -->
            <div class="payment-details">
                <button id="showPaymentDetailsBtn" class="text-blue-500 hover:text-blue-700 font-medium py-2 w-full transition focus:outline-none">
                    Детали платежей
                </button>
                <div id="paymentDetailsList" class="hidden p-4 bg-gray-50">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-red-100 p-3 rounded-lg">
                            <h3 class="text-red-800 font-semibold mb-2">Разовые платежи</h3>
                            <div id="oneTimePaymentsList">
                                <p class="text-red-700 font-bold">0</p>
                            </div>
                        </div>
                        <div class="bg-green-100 p-3 rounded-lg">
                            <h3 class="text-green-800 font-semibold mb-2">Постоянные платежи</h3>
                            <div id="recurringPaymentsList">
                                <p class="text-green-700 font-bold">0</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="overlay" class="overlay hidden">
            <div class="dialog">
                <div id="actionsMenu" class="p-4">
                    <div class="selected-date">
                        <h3 class="text-lg font-semibold" id="selectedDateTitle"></h3>
                    </div>
                    <div class="grid grid-cols-1 gap-2">
                        <button id="addPaymentBtn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">
                            Добавить платеж
                        </button>
                        <button id="deletePaymentsBtn" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition">
                            Удалить платежи
                        </button>
                        <button id="showDescriptionsBtn" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition">
                            Просмотреть платежи
                        </button>
                    </div>
                    <div class="flex justify-end mt-4">
                        <button id="cancelActions" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 transition">
                            Закрыть
                        </button>
                    </div>
                </div>

                <div id="addPaymentForm" class="p-4 hidden">
                    <div class="selected-date">
                        <h3 class="text-lg font-semibold" id="formTitle"></h3>
                    </div>
                    <form id="paymentForm">
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2" for="amount">Сумма (₽)</label>
                            <input type="number" id="amount" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2" for="description">Описание</label>
                            <input type="text" id="description" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2">Тип платежа</label>
                            <div class="flex border rounded overflow-hidden">
                                <div id="oneTimeOption" class="toggle-option flex-1 active" data-value="one-time">
                                    Разовый
                                </div>
                                <div id="recurringOption" class="toggle-option flex-1" data-value="recurring">
                                    Постоянный
                                </div>
                            </div>
                            <input type="hidden" id="paymentType" name="paymentType" value="one-time">
                        </div>
                        <div class="flex space-x-2">
                            <button type="submit" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">
                                Добавить
                            </button>
                            <button type="button" id="cancelAdd" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 transition">
                                Отмена
                            </button>
                        </div>
                    </form>
                </div>

                <div id="deletePaymentsList" class="p-4 hidden">
                    <div class="selected-date">
                        <h3 class="text-lg font-semibold">Выберите платежи для удаления</h3>
                    </div>
                    <div id="paymentsToDelete" class="mb-4"></div>
                    <div class="flex justify-end">
                        <button id="cancelDelete" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 transition">
                            Назад
                        </button>
                    </div>
                </div>

                <div id="paymentsDescriptionList" class="p-4 hidden">
                    <div class="selected-date">
                        <h3 class="text-lg font-semibold">Платежи</h3>
                    </div>
                    <div id="paymentsDescriptions" class="mb-4"></div>
                    <div class="flex justify-end">
                        <button id="cancelDescription" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 transition">
                            Назад
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            deleteDoc, 
            doc, 
            query, 
            where, 
            onSnapshot,
            getDoc,
            setDoc
        } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        // Конфигурация Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAPX_GlZVyQN7KwFY-MdtJBE_VyJGsfGPc",
            authDomain: "payment-calendar-5e433.firebaseapp.com",
            projectId: "payment-calendar-5e433",
            storageBucket: "payment-calendar-5e433.appspot.com",
            messagingSenderId: "878161899746",
            appId: "1:878161899746:web:d986d3296683d08c80eebb",
            measurementId: "G-6B7DT74CWE"
        };

        // Глобальные переменные
        let app;
        let db;
        let currentDate = new Date();
        let currentMonth = currentDate.getMonth();
        let currentYear = currentDate.getFullYear();
        let selectedDate = null;
        let paymentsData = {};
        let currentUserId = null;
        let unsubscribePayments = null;

        const months = [
            'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
            'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
        ];

        // Инициализация Firebase
        async function initFirebase() {
            try {
                console.log('Initializing Firebase...');
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                return true;
            } catch (error) {
                console.error('Firebase initialization error:', error);
                alert('Ошибка подключения к базе данных: ' + error.message);
                return false;
            }
        }

        // Список разрешенных User ID
        const ALLOWED_USER_IDS = [
            "564940168",
            "579486395"
        ];

        // Функции аутентификации
        function checkAuth() {
            // Временное разрешение для тестирования без Telegram
            currentUserId = "579486395";
            return true;

            // Закомментированный оригинальный код
            /*
            try {
                const tg = window.Telegram.WebApp;
                
                if (!tg.initDataUnsafe?.user?.id) {
                    showAuthError("Не удалось получить данные пользователя");
                    return false;
                }

                const userId = tg.initDataUnsafe.user.id.toString();
                
                if (!ALLOWED_USER_IDS.includes(userId)) {
                    showAuthError("Доступ запрещен");
                    return false;
                }

                currentUserId = userId;
                return true;
            } catch (error) {
                showAuthError("Ошибка авторизации");
                return false;
            }
            */
        }

        function showAuthError(message) {
            document.getElementById('authErrorMessage').textContent = message;
            document.getElementById('authErrorContainer').classList.remove('hidden');
            document.getElementById('appContainer').classList.add('hidden');
        }

        // Функции календаря
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDisplayDate(date) {
            return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
        }

        function calculateMonthTotal() {
            let total = 0;
            
            Object.entries(paymentsData).forEach(([dateString, payments]) => {
                const date = new Date(dateString);
                if (date.getMonth() === currentMonth && date.getFullYear() === currentYear) {
                    payments.forEach(payment => {
                        total += Number(payment.amount) || 0;
                    });
                }
            });

            // Добавляем повторяющиеся платежи из предыдущих месяцев
            Object.entries(paymentsData).forEach(([dateString, payments]) => {
                const paymentDate = new Date(dateString);
                payments.forEach(payment => {
                    if (payment.paymentType === 'recurring') {
                        // Получаем день месяца из оригинального платежа
                        const paymentDay = paymentDate.getDate();
                        
                        // Создаем дату для текущего месяца с тем же днем
                        const newDate = new Date(currentYear, currentMonth, paymentDay);
                        
                        // Проверяем, что дата действительна и больше или равна начальной дате
                        if (!isNaN(newDate.getTime()) && newDate >= paymentDate) {
                            // Проверяем, не учтен ли уже этот платеж
                            const dateStr = formatDate(newDate);
                            const existingPayments = paymentsData[dateStr] || [];
                            const isAlreadyCounted = existingPayments.some(p => 
                                p.id === payment.id && p.paymentType === 'recurring'
                            );
                            
                            if (!isAlreadyCounted) {
                                total += Number(payment.amount) || 0;
                            }
                        }
                    }
                });
            });
            
            document.getElementById('monthTotal').textContent = total.toLocaleString();
        }

        // Отдельная функция для установки слушателей
        function setupPaymentListeners() {
            // Отписываемся от старых слушателей, если они есть
            if (unsubscribePayments) {
                unsubscribePayments();
            }

            const oneTimeItemsRef = collection(db, "payments/one_time/items");
            const recurringItemsRef = collection(db, "payments/recurring/items");

            let updateTimeout;
            let updateNeeded = false;

            function debouncedUpdate() {
                if (updateTimeout) {
                    clearTimeout(updateTimeout);
                }
                updateTimeout = setTimeout(async () => {
                    if (updateNeeded) {
                        await initCalendar();
                        updateNeeded = false;
                    }
                }, 300);
            }

            // Устанавливаем новые слушатели
            const unsubscribeOneTime = onSnapshot(oneTimeItemsRef, (snapshot) => {
                console.log('One-time payments updated');
                updateNeeded = true;
                debouncedUpdate();
            });

            const unsubscribeRecurring = onSnapshot(recurringItemsRef, (snapshot) => {
                console.log('Recurring payments updated');
                updateNeeded = true;
                debouncedUpdate();
            });

            // Сохраняем функции отписки
            unsubscribePayments = () => {
                if (updateTimeout) {
                    clearTimeout(updateTimeout);
                }
                unsubscribeOneTime();
                unsubscribeRecurring();
            };
        }

        async function initCalendar() {
            try {
                console.log('Starting calendar initialization...');
                const newPaymentsData = {};

                // Получаем разовые платежи
                const oneTimeItemsRef = collection(db, "payments/one_time/items");
                const oneTimeSnapshot = await getDocs(oneTimeItemsRef);
                console.log('Found one-time payments:', oneTimeSnapshot.size);

                // Обрабатываем разовые платежи
                oneTimeSnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.date && data.date.toDate) {
                        const date = data.date.toDate();
                        const dateString = formatDate(date);
                        
                        if (!newPaymentsData[dateString]) {
                            newPaymentsData[dateString] = [];
                        }
                        
                        newPaymentsData[dateString].push({
                            amount: Number(data.amount) || 0,
                            description: data.description || '',
                            paymentType: 'one-time',
                            id: doc.id,
                            userId: data.userId || currentUserId
                        });
                    }
                });

                // Получаем повторяющиеся платежи
                const recurringItemsRef = collection(db, "payments/recurring/items");
                const recurringSnapshot = await getDocs(recurringItemsRef);
                console.log('Found recurring payments:', recurringSnapshot.size);

                // Обрабатываем повторяющиеся платежи
                for (const doc of recurringSnapshot.docs) {
                    const template = doc.data();
                    if (template.startDate && template.startDate.toDate) {
                        const date = template.startDate.toDate();
                        const dateString = formatDate(date);
                        
                        if (!newPaymentsData[dateString]) {
                            newPaymentsData[dateString] = [];
                        }
                        
                        newPaymentsData[dateString].push({
                            amount: Number(template.amount) || 0,
                            description: template.description || '',
                            paymentType: 'recurring',
                            id: doc.id,
                            userId: template.userId || currentUserId
                        });

                        // Получаем экземпляры повторяющегося платежа
                        const instancesRef = collection(doc.ref, "instances");
                        const instancesSnapshot = await getDocs(instancesRef);
                        
                        instancesSnapshot.forEach(instance => {
                            const instanceData = instance.data();
                            if (instanceData.date && instanceData.date.toDate) {
                                const instanceDate = instanceData.date.toDate();
                                const instanceDateString = formatDate(instanceDate);
                                
                                if (!newPaymentsData[instanceDateString]) {
                                    newPaymentsData[instanceDateString] = [];
                                }
                                
                                newPaymentsData[instanceDateString].push({
                                    amount: Number(instanceData.amount) || Number(template.amount) || 0,
                                    description: instanceData.description || template.description || '',
                                    paymentType: 'recurring',
                                    id: instance.id,
                                    templateId: doc.id,
                                    userId: template.userId || currentUserId
                                });
                            }
                        });
                    }
                }

                // Обновляем данные только после полной обработки
                paymentsData = newPaymentsData;
                console.log('Processed payments data:', paymentsData);
                generateCalendar(currentMonth, currentYear);

            } catch (error) {
                console.error('Error in initCalendar:', error);
                alert('Ошибка инициализации календаря: ' + error.message);
            }
        }

        function generateCalendar(month, year) {
            try {
                console.log('Generating calendar for:', months[month], year);
                const calendarDays = document.getElementById('calendarDays');
                const currentMonthElement = document.getElementById('currentMonth');
                
                if (!calendarDays || !currentMonthElement) {
                    throw new Error('Calendar elements not found');
                }
                
                // Создаем временные данные для текущего месяца
                const monthPaymentsData = {};
                
                // Копируем существующие платежи для текущего месяца
                Object.entries(paymentsData).forEach(([dateString, payments]) => {
                    const paymentDate = new Date(dateString);
                    if (paymentDate.getMonth() === month && paymentDate.getFullYear() === year) {
                        // Копируем платежи без дублирования
                        monthPaymentsData[dateString] = [...payments];
                    }
                });
                
                // Добавляем повторяющиеся платежи
                Object.entries(paymentsData).forEach(([dateString, payments]) => {
                    payments.forEach(payment => {
                        if (payment.paymentType === 'recurring') {
                            const paymentDate = new Date(dateString);
                            const paymentDay = paymentDate.getDate();
                            
                            // Создаем дату для текущего месяца с тем же днем
                            const newDate = new Date(year, month, paymentDay);
                            
                            // Проверяем только валидность даты
                            if (!isNaN(newDate.getTime())) {
                                const newDateString = formatDate(newDate);
                                
                                if (!monthPaymentsData[newDateString]) {
                                    monthPaymentsData[newDateString] = [];
                                }
                                
                                // Проверяем, не существует ли уже такой платеж
                                const existingPayment = monthPaymentsData[newDateString].some(p => 
                                    p.id === payment.id && p.paymentType === 'recurring'
                                );
                                
                                if (!existingPayment) {
                                    // Добавляем информацию о том, является ли это будущим или прошлым платежом
                                    const isPast = newDate < paymentDate;
                                    monthPaymentsData[newDateString].push({
                                        ...payment,
                                        amount: Number(payment.amount) || 0,
                                        isRecurring: true,
                                        isPast,
                                        originalDate: paymentDate
                                    });
                                }
                            }
                        }
                    });
                });
                
                currentMonthElement.textContent = `${months[month]} ${year}`;
                calendarDays.innerHTML = '';
                
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const firstDayOfWeek = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
                const prevLastDay = new Date(year, month, 0).getDate();
                
                // Добавляем дни предыдущего месяца
                for (let i = firstDayOfWeek; i > 0; i--) {
                    const day = prevLastDay - i + 1;
                    const prevDate = new Date(year, month - 1, day);
                    const dayElement = createDayElement(day, prevDate, true, monthPaymentsData);
                    calendarDays.appendChild(dayElement);
                }
                
                // Добавляем дни текущего месяца
                for (let i = 1; i <= lastDay.getDate(); i++) {
                    const date = new Date(year, month, i);
                    const dayElement = createDayElement(i, date, false, monthPaymentsData);
                    calendarDays.appendChild(dayElement);
                }
                
                calculateMonthTotal();
                
                // Если детали платежей открыты - обновляем их
                const detailsList = document.getElementById('paymentDetailsList');
                if (!detailsList.classList.contains('hidden')) {
                    updatePaymentDetails();
                }
                
            } catch (error) {
                console.error('Error in generateCalendar:', error);
                alert('Ошибка генерации календаря: ' + error.message);
            }
        }

        // Обновляем функцию создания элемента дня
        function createDayElement(dayNumber, date, isPrevMonth, monthPaymentsData) {
            const dateString = formatDate(date);
            const payments = monthPaymentsData[dateString] || [];
            
            const dayElement = document.createElement('div');
            const isToday = date.getDate() === currentDate.getDate() && 
                           date.getMonth() === currentDate.getMonth() && 
                           date.getFullYear() === currentDate.getFullYear();
            
            let dayClasses = 'text-center py-1 day-cell rounded cursor-pointer';
            if (isToday) {
                dayClasses += ' bg-blue-100 font-bold';
            }
            if (isPrevMonth) {
                dayClasses += ' text-gray-400';
            }
            if (payments.length > 0) {
                dayClasses += ' has-payments';
            }
            
            let paymentDisplay = '';
            if (payments.length > 0) {
                const totalAmount = payments.reduce((sum, payment) => sum + Number(payment.amount), 0);
                const hasRecurring = payments.some(p => p.paymentType === 'recurring');
                const hasPastRecurring = payments.some(p => p.isPast);
                
                let colorClass = 'text-red-600';
                if (hasRecurring) {
                    colorClass = hasPastRecurring ? 'text-blue-600' : 'text-green-600';
                }
                
                paymentDisplay = `
                    <div class="payment-amount text-xs font-medium ${colorClass}">
                        ${totalAmount.toLocaleString()}
                    </div>
                `;
            } else {
                paymentDisplay = '<div class="payment-amount text-xs h-4"></div>';
            }
            
            dayElement.className = dayClasses;
            dayElement.innerHTML = `
                <div class="day-content">${dayNumber}</div>
                ${paymentDisplay}
            `;
            
            if (!isPrevMonth) {
                dayElement.addEventListener('click', () => {
                    selectedDate = date;
                    document.getElementById('selectedDateTitle').textContent = 
                        `Платежи на ${formatDisplayDate(date)}`;
                    showActionsMenu();
                });
            }
            
            return dayElement;
        }

        function showOverlay() {
            document.getElementById('overlay').classList.remove('hidden');
        }

        function hideOverlay() {
            document.getElementById('overlay').classList.add('hidden');
        }

        function showActionsMenu() {
            hideAllForms();
            showOverlay();
            document.getElementById('actionsMenu').classList.remove('hidden');
        }

        function showAddForm() {
            hideAllForms();
            document.getElementById('addPaymentForm').classList.remove('hidden');
            document.getElementById('formTitle').textContent = 
                `Добавить платеж на ${formatDisplayDate(selectedDate)}`;
        }

        function showDeleteList() {
            hideAllForms();
            const container = document.getElementById('paymentsToDelete');
            container.innerHTML = '';
            
            const dateString = formatDate(selectedDate);
            
            // Получаем обычные платежи для выбранной даты
            const regularPayments = paymentsData[dateString] || [];
            
            // Получаем повторяющиеся платежи из предыдущих месяцев
            const recurringPayments = [];
            Object.entries(paymentsData).forEach(([paymentDateString, payments]) => {
                const paymentDate = new Date(paymentDateString);
                payments.forEach(payment => {
                    if (payment.paymentType === 'recurring') {
                        const paymentDay = paymentDate.getDate();
                        
                        if (paymentDay === selectedDate.getDate() && 
                            (paymentDate.getMonth() !== selectedDate.getMonth() || 
                             paymentDate.getFullYear() !== selectedDate.getFullYear())) {
                            
                            if (selectedDate >= paymentDate) {
                                const isAlreadyAdded = regularPayments.some(p => 
                                    p.id === payment.id && p.paymentType === 'recurring'
                                );
                                
                                if (!isAlreadyAdded) {
                                    recurringPayments.push({
                                        ...payment,
                                        originalDate: paymentDate,
                                        isRecurring: true
                                    });
                                }
                            }
                        }
                    }
                });
            });
            
            const allPayments = [...regularPayments, ...recurringPayments];
            
            if (allPayments.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Нет платежей для удаления</p>';
            } else {
                // Сортируем платежи: сначала разовые, потом повторяющиеся
                allPayments.sort((a, b) => {
                    if (a.paymentType === b.paymentType) {
                        return 0;
                    }
                    return a.paymentType === 'one-time' ? -1 : 1;
                });

                allPayments.forEach(payment => {
                    const paymentEl = document.createElement('div');
                    paymentEl.className = 'payment-item flex justify-between items-center p-3 border-b border-gray-200';
                    
                    const isRecurring = payment.paymentType === 'recurring';
                    
                    paymentEl.innerHTML = `
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-1">
                                <span class="font-medium">${payment.amount.toLocaleString()}</span>
                            </div>
                            ${payment.description ? `
                                <div class="text-sm text-gray-600">
                                    ${payment.description}
                                </div>
                            ` : ''}
                        </div>
                        <button class="delete-btn ml-4 px-3 py-1 bg-red-50 text-red-600 rounded hover:bg-red-100 transition-colors" 
                                data-id="${payment.id}" 
                                data-type="${payment.paymentType}"
                                ${payment.templateId ? `data-template-id="${payment.templateId}"` : ''}>
                            Удалить
                        </button>
                    `;
                    container.appendChild(paymentEl);
                });

                // Добавляем обработчики для кнопок удаления
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        try {
                            const paymentId = this.dataset.id;
                            const paymentType = this.dataset.type;
                            const templateId = this.dataset.templateId;

                            if (paymentType === 'recurring') {
                                if (templateId) {
                                    // Удаляем конкретный экземпляр повторяющегося платежа
                                    const templateRef = doc(db, `payments/recurring/items/${templateId}`);
                                    const instanceRef = doc(templateRef, `instances/${paymentId}`);
                                    await deleteDoc(instanceRef);
                                } else {
                                    // Удаляем весь шаблон повторяющегося платежа
                                    const recurringRef = doc(db, `payments/recurring/items/${paymentId}`);
                                    await deleteDoc(recurringRef);
                                }
                            } else {
                                // Удаляем разовый платеж
                                const oneTimeRef = doc(db, `payments/one_time/items/${paymentId}`);
                                await deleteDoc(oneTimeRef);
                            }

                            // Удаляем элемент из интерфейса
                            const paymentItem = this.closest('.payment-item');
                            paymentItem.remove();

                            // Если платежей больше нет, показываем сообщение
                            if (container.children.length === 0) {
                                container.innerHTML = '<p class="text-gray-500 text-center py-4">Нет платежей для удаления</p>';
                            }
                        } catch (error) {
                            console.error("Error deleting payment: ", error);
                            alert("Ошибка при удалении платежа: " + error.message);
                        }
                    });
                });
            }
            
            document.getElementById('deletePaymentsList').classList.remove('hidden');
        }

        function showDescriptions() {
            hideAllForms();
            const container = document.getElementById('paymentsDescriptions');
            container.innerHTML = '';
            
            const dateString = formatDate(selectedDate);
            
            // Получаем обычные платежи для выбранной даты
            const regularPayments = paymentsData[dateString] || [];
            
            // Получаем повторяющиеся платежи из предыдущих месяцев
            const recurringPayments = [];
            Object.entries(paymentsData).forEach(([paymentDateString, payments]) => {
                const paymentDate = new Date(paymentDateString);
                payments.forEach(payment => {
                    if (payment.paymentType === 'recurring') {
                        // Получаем день месяца из оригинального платежа
                        const paymentDay = paymentDate.getDate();
                        
                        // Если день совпадает с выбранной датой и это не тот же самый месяц
                        if (paymentDay === selectedDate.getDate() && 
                            (paymentDate.getMonth() !== selectedDate.getMonth() || 
                             paymentDate.getFullYear() !== selectedDate.getFullYear())) {
                            
                            // Проверяем, что выбранная дата не раньше начальной даты платежа
                            if (selectedDate >= paymentDate) {
                                // Проверяем, не добавлен ли уже этот платеж
                                const isAlreadyAdded = regularPayments.some(p => 
                                    p.id === payment.id && p.paymentType === 'recurring'
                                );
                                
                                if (!isAlreadyAdded) {
                                    recurringPayments.push({
                                        ...payment,
                                        originalDate: paymentDate,
                                        isRecurring: true
                                    });
                                }
                            }
                        }
                    }
                });
            });
            
            const allPayments = [...regularPayments, ...recurringPayments];
            
            if (allPayments.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Нет платежей для отображения</p>';
            } else {
                // Сортируем платежи: сначала разовые, потом повторяющиеся
                allPayments.sort((a, b) => {
                    if (a.paymentType === b.paymentType) {
                        return 0;
                    }
                    return a.paymentType === 'one-time' ? -1 : 1;
                });

                allPayments.forEach(payment => {
                    const paymentEl = document.createElement('div');
                    paymentEl.className = 'payment-item';
                    
                    const isRecurring = payment.paymentType === 'recurring';
                    
                    paymentEl.innerHTML = `
                        <div class="w-full">
                            <div class="font-medium flex justify-between items-center">
                                <span>${payment.amount.toLocaleString()}</span>
                                <span class="text-xs px-2 py-1 rounded ${isRecurring ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                                    ${isRecurring ? 'постоянный' : 'разовый'}
                                </span>
                            </div>
                            ${payment.description ? `
                                <div class="text-sm text-gray-600 mt-1">
                                    ${payment.description}
                                </div>
                            ` : ''}
                        </div>
                    `;
                    container.appendChild(paymentEl);
                });

                // Добавляем итоговую сумму
                const totalAmount = allPayments.reduce((sum, payment) => sum + Number(payment.amount), 0);
                const totalEl = document.createElement('div');
                totalEl.className = 'mt-4 pt-4 border-t border-gray-200';
                totalEl.innerHTML = `
                    <div class="font-bold text-right">
                        Итого: ${totalAmount.toLocaleString()}
                    </div>
                `;
                container.appendChild(totalEl);
            }
            
            document.getElementById('paymentsDescriptionList').classList.remove('hidden');
        }

        function hideAllForms() {
            document.getElementById('actionsMenu').classList.add('hidden');
            document.getElementById('addPaymentForm').classList.add('hidden');
            document.getElementById('deletePaymentsList').classList.add('hidden');
            document.getElementById('paymentsDescriptionList').classList.add('hidden');
        }

        // Инициализация приложения
        async function initApp() {
            try {
                console.log('Starting app initialization...');
                
                // Показываем контейнер приложения
                const appContainer = document.getElementById('appContainer');
                if (!appContainer) {
                    throw new Error('App container not found');
                }
                
                // Удаляем класс hidden
                appContainer.style.display = 'block';
                appContainer.classList.remove('hidden');
                
                // Инициализируем Firebase
                const firebaseInitialized = await initFirebase();
                if (!firebaseInitialized) {
                    throw new Error('Firebase initialization failed');
                }
                
                // Проверяем авторизацию
                if (!checkAuth()) {
                    console.error('Auth check failed');
                    return;
                }
                
                console.log('Auth check passed, initializing calendar...');
                await initCalendar();
                
                // Устанавливаем слушатели только один раз при инициализации
                setupPaymentListeners();
                
            } catch (error) {
                console.error('Error during app initialization:', error);
                alert('Ошибка инициализации приложения: ' + error.message);
            }
        }

        // Обработчики событий
        window.addEventListener('load', () => {
            console.log('Window loaded');
            initApp();
        });

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM Content Loaded');
            initApp();
        });

        document.getElementById('prevMonth').addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            generateCalendar(currentMonth, currentYear);
        });
        
        document.getElementById('nextMonth').addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            generateCalendar(currentMonth, currentYear);
        });

        document.getElementById('addPaymentBtn').addEventListener('click', showAddForm);
        document.getElementById('deletePaymentsBtn').addEventListener('click', showDeleteList);
        document.getElementById('showDescriptionsBtn').addEventListener('click', showDescriptions);
        
        document.getElementById('cancelActions').addEventListener('click', hideOverlay);
        document.getElementById('cancelAdd').addEventListener('click', showActionsMenu);
        document.getElementById('cancelDelete').addEventListener('click', showActionsMenu);
        document.getElementById('cancelDescription').addEventListener('click', showActionsMenu);

        document.getElementById('oneTimeOption').addEventListener('click', function() {
            this.classList.add('active', 'bg-blue-500', 'text-white');
            document.getElementById('recurringOption').classList.remove('active', 'bg-blue-500', 'text-white');
            document.getElementById('paymentType').value = 'one-time';
        });

        document.getElementById('recurringOption').addEventListener('click', function() {
            this.classList.add('active', 'bg-blue-500', 'text-white');
            document.getElementById('oneTimeOption').classList.remove('active', 'bg-blue-500', 'text-white');
            document.getElementById('paymentType').value = 'recurring';
        });

        document.getElementById('paymentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const amount = parseFloat(document.getElementById('amount').value);
            const description = document.getElementById('description').value;
            const paymentType = document.getElementById('paymentType').value;
            
            try {
                const paymentData = {
                    amount: amount,
                    description: description,
                    userId: currentUserId,
                    createdAt: new Date()
                };

                if (paymentType === 'one-time') {
                    // Для разовых платежей
                    const oneTimeRef = collection(db, "payments/one_time/items");
                    paymentData.date = selectedDate;
                    await addDoc(oneTimeRef, paymentData);
                } else {
                    // Для повторяющихся платежей
                    const recurringRef = collection(db, "payments/recurring/items");
                    paymentData.startDate = selectedDate;
                    await addDoc(recurringRef, paymentData);
                }
                
                document.getElementById('paymentForm').reset();
                hideOverlay();
            } catch (error) {
                console.error("Error adding payment: ", error);
                alert("Ошибка при добавлении платежа: " + error.message);
            }
        });

        document.getElementById('overlay').addEventListener('click', (e) => {
            if (e.target === document.getElementById('overlay')) {
                hideOverlay();
            }
        });

        // Обработчик для кнопки детализации платежей
        document.getElementById('showPaymentDetailsBtn').addEventListener('click', function() {
            const detailsList = document.getElementById('paymentDetailsList');
            const isHidden = detailsList.classList.contains('hidden');
            
            if (isHidden) {
                // Показываем детали
                detailsList.classList.remove('hidden');
                updatePaymentDetails();
            } else {
                // Скрываем детали
                detailsList.classList.add('hidden');
            }
        });

        // Функция для обновления деталей платежей
        function updatePaymentDetails() {
            console.log('Updating payment details for month:', months[currentMonth], currentYear);
            
            // Контейнеры для списков платежей
            const oneTimeContainer = document.getElementById('oneTimePaymentsList');
            const recurringContainer = document.getElementById('recurringPaymentsList');
            
            // Очищаем контейнеры
            oneTimeContainer.innerHTML = '';
            recurringContainer.innerHTML = '';
            
            // Переменные для подсчета сумм
            let oneTimeTotal = 0;
            let recurringTotal = 0;
            
            // Временные данные для месяца
            const monthPaymentsData = {};
            
            // Копируем существующие платежи для текущего месяца
            Object.entries(paymentsData).forEach(([dateString, payments]) => {
                const paymentDate = new Date(dateString);
                if (paymentDate.getMonth() === currentMonth && paymentDate.getFullYear() === currentYear) {
                    monthPaymentsData[dateString] = [...payments];
                }
            });
            
            // Добавляем повторяющиеся платежи для отображения
            Object.entries(paymentsData).forEach(([dateString, payments]) => {
                payments.forEach(payment => {
                    if (payment.paymentType === 'recurring') {
                        const paymentDate = new Date(dateString);
                        const paymentDay = paymentDate.getDate();
                        
                        // Создаем дату для текущего месяца с тем же днем
                        const newDate = new Date(currentYear, currentMonth, paymentDay);
                        
                        // Проверяем валидность даты
                        if (!isNaN(newDate.getTime())) {
                            const newDateString = formatDate(newDate);
                            
                            if (!monthPaymentsData[newDateString]) {
                                monthPaymentsData[newDateString] = [];
                            }
                            
                            // Проверяем, не существует ли уже такой платеж
                            const existingPayment = monthPaymentsData[newDateString].some(p => 
                                p.id === payment.id && p.paymentType === 'recurring'
                            );
                            
                            if (!existingPayment) {
                                monthPaymentsData[newDateString].push({
                                    ...payment,
                                    amount: Number(payment.amount) || 0,
                                    isRecurring: true
                                });
                            }
                        }
                    }
                });
            });
            
            // Собираем платежи по типам для сортировки
            const oneTimePayments = [];
            const recurringPayments = [];
            
            // Обрабатываем платежи для отображения
            Object.entries(monthPaymentsData).forEach(([dateString, payments]) => {
                payments.forEach(payment => {
                    const amount = Number(payment.amount) || 0;
                    const date = new Date(dateString);
                    const day = date.getDate();
                    
                    const formattedDate = `${day} ${months[currentMonth].toLowerCase()}`;
                    const description = payment.description || 'Платеж';
                    
                    if (payment.paymentType === 'one-time') {
                        // Разовый платеж
                        oneTimeTotal += amount;
                        oneTimePayments.push({ date, formattedDate, description, amount });
                    } else {
                        // Повторяющийся платеж
                        recurringTotal += amount;
                        recurringPayments.push({ date, formattedDate, description, amount });
                    }
                });
            });
            
            // Сортируем платежи по дате
            oneTimePayments.sort((a, b) => a.date - b.date);
            recurringPayments.sort((a, b) => a.date - b.date);
            
            // Добавляем платежи в контейнеры
            oneTimePayments.forEach(payment => {
                const paymentItem = document.createElement('div');
                paymentItem.className = 'payment-details-item';
                paymentItem.innerHTML = `
                    <span>${payment.formattedDate}: ${payment.description}</span>
                    <span>${payment.amount.toLocaleString()}</span>
                `;
                oneTimeContainer.appendChild(paymentItem);
            });
            
            recurringPayments.forEach(payment => {
                const paymentItem = document.createElement('div');
                paymentItem.className = 'payment-details-item';
                paymentItem.innerHTML = `
                    <span>${payment.formattedDate}: ${payment.description}</span>
                    <span>${payment.amount.toLocaleString()}</span>
                `;
                recurringContainer.appendChild(paymentItem);
            });
            
            // Добавляем итоговые суммы
            if (oneTimePayments.length === 0) {
                oneTimeContainer.innerHTML = '<p class="text-red-700 font-bold">0</p>';
            } else {
                const totalEl = document.createElement('div');
                totalEl.className = 'payment-details-total';
                totalEl.innerHTML = `Итого: ${oneTimeTotal.toLocaleString()}`;
                oneTimeContainer.appendChild(totalEl);
            }
            
            if (recurringPayments.length === 0) {
                recurringContainer.innerHTML = '<p class="text-green-700 font-bold">0</p>';
            } else {
                const totalEl = document.createElement('div');
                totalEl.className = 'payment-details-total';
                totalEl.innerHTML = `Итого: ${recurringTotal.toLocaleString()}`;
                recurringContainer.appendChild(totalEl);
            }
        }
    </script>
</body>
</html>
